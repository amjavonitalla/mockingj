/*!
 * angular-sails
 * An angular provider for using the sails socket.io api
 * @version v2.0.0-beta.3
 * @link https://github.com/janpantel/angular-sails
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(e,t,n){"use strict";function r(e){var n,r,o,s={};return e?(t.forEach(e.split("\n"),function(e){o=e.indexOf(":"),n=t.lowercase(a(e.substr(0,o))),r=a(e.substr(o+1)),n&&(s[n]=s[n]?s[n]+", "+r:r)}),s):s}function o(e,n){var r,o={};return t.forEach(e,function(e,s){t.isFunction(e)?(r=e(n),null!=r&&(o[s]=r)):o[s]=e}),o}function s(e,n){var r,s,a,c=t.extend({},e.headers);n=t.extend({},n.common,n[t.lowercase(e.method)]);e:for(r in n){s=t.lowercase(r);for(a in c)if(t.lowercase(a)===s)continue e;c[r]=n[r]}return o(c,i(e))}function i(e,n){if(t.isArray(e)){n=n||[];for(var r=0,o=e.length;o>r;r++)n[r]=e[r]}else if(t.isObject(e)){n=n||{};for(var s in e)("$"!==s.charAt(0)||"$"!==s.charAt(1))&&(n[s]=e[s])}return n||e}function a(e){return t.isString(e)?e.trim():e}function c(e){return e&&t.isFunction(e.then)}function u(e){var o=t.isObject(e)?e:n;return function(n){if(o||(o=r(e)),n){var s=o[t.lowercase(n)];return void 0===s&&(s=null),s}return o}}function d(e,n){if(!t.isArray(e))throw new TypeError('Expected type "array" by got type "'+Object.prototype.toString.call(e)+'".');if(Array.prototype.indexOf)return e.indexOf(n);var r=0,o=e.length;if(0===o)return-1;for(;o>r;){if(r in e&&e[r]===n)return r;r++}return-1}function f(e,n){var r=this,o=["post","put","patch"];r.httpVerbs=n.httpVerbs=["get","post","put","patch","delete","head"],r.eventNames=n.eventNames=["on","off","once"],r.config={transports:["websocket","polling"]},r.debug=e.debug=n.debug=!1,r["debugger"]=function(t){r.debug=e.debug=n.debug=t},r.defaults={transformResponse:[],transformRequest:[],headers:{}},r.interceptors=e.interceptors=[],this.$get=["$rootScope","$q","$log","$timeout","$sailsIo","$sailsInterceptor",function(e,n,i,a,c,f){function l(e){return l[e.method](e.url,e)}function h(e){l[e]=v[e].bind(v)}function p(e){l[e]=function(n,i,a){var c={method:e,transformRequest:r.defaults.transformRequest,transformResponse:r.defaults.transformResponse};a=a||{},-1===d(o,e)?(a=i||a,delete a.data):a.data=i,c=t.extend({},c,a),c.method=t.uppercase(c.method||e),c.headers=s(c,r.defaults.headers),c.url=(r.urlPrefix||"")+(n||c.url),t.isUndefined(c.withCredentials)&&!t.isUndefined(r.defaults.withCredentials)&&(c.withCredentials=r.defaults.withCredentials);var l=f(v[e].bind(v),c);return l.success=function(e){return l.then(function(t){e(t.data,t.status,u(t.headers),t.config)}),l},l.error=function(e){return l.then(null,function(t){e(t.data,t.status,u(t.headers),t.config)}),l},l}}function g(e){l[e]=v[e].bind(v)}var v=new c(r.socket||r.url,r.config),m=["connect","disconnect","isConnected"];return l._socket=v,t.forEach(r.httpVerbs,p,this),t.forEach(r.eventNames,g,this),t.forEach(m,h,this),l.$modelUpdater=function(n,r){var o=function(n){e.$evalAsync(function(){var e;switch(n.verb){case"created":r.push(n.data);break;case"updated":var o;for(e=0;e<r.length;e++)if(r[e].id===n.id){o=r[e];break}if(!o&&!n.previous)return;o||(o=n.previous,r.push(o)),t.extend(o,n.data);break;case"destroyed":for(e=0;e<r.length;e++)if(r[e].id===n.id){r.splice(e,1);break}}})};return v._socket.on(n,o),function(){v._socket.off(n,o)}},l.defaults=this.defaults,l}]}function l(){var e=this;e.interceptors=[],this.$get=["$injector","$q",function(r,o){function s(e){return t.extend({},e,{data:a(e.data,u(e.headers),e.transformRequest||[])})}function i(e){var n=t.extend({},e,{data:a(e.data,e.headers,e.config&&e.config.transformResponse||[])});return 200<=e.status&&e.status<300?n:o.reject(n)}function a(e,n,r){return t.isFunction(r)?r(e,n):(t.forEach(r,function(t){e=t(e,n)}),e)}var d=[];t.forEach(e.interceptors,function(e){d.unshift(t.isString(e)?r.get(e):r.invoke(e))});var f=function(e,r){var a=e;c(e)&&(a=function(){return e});var u=[s,n,a,n,i,i],f=o.when(r);for(t.forEach(d,function(e){(e.request||e.requestError)&&u.unshift(e.request,e.requestError),(e.response||e.responseError)&&u.push(e.response,e.responseError)});u.length;){var l=u.shift(),h=u.shift();f=f.then(l,h)}return f};return f}]}function h(){var e=this;e.httpVerbs=["get","post","put","delete"],e.eventNames=["on","off","once"],this.$get=["$rootScope","$q","$log","socketIo","sailsSdk",function(n,r,o,s,i){function a(e,t){return this.connect(e,t)}var c=s;return a.prototype.connect=function(n,s){var a=this;if(s=s||{},a._socket&&a._socket.connected)throw new Error("Socket is already connected.");return a.connectDefer||(a.connectDefer=r.defer()),t.isObject(n)&&t.isFunction(n.on)&&t.isFunction(n.emit)?(a._socket=n,a.connectDefer.resolve()):(t.isString(s.query)?s.query+="&"+i.versionString():s.query=i.versionString(),a._socket&&a._socket.connected||(a._socket=c(n||s.url,s),a.connectDefer.resolve())),e.debug&&(a.on("connect",o.info.bind(a,"$sails connected.")),a.on("disconnect",o.info.bind(a,"$sails disconnected.")),a.on("reconnecting",function(e){o.warn.bind(a,"$sails is attemping to reconnect. (#"+e+")")}),a.on("reconnect",function(e,t){o.info.bind(a,"$sails successfully reconnected after "+t+" attemps.")}),a.on("error",function(e){o.error("$sails could not connect:",e)})),a},a.prototype.disconnect=function(){var e=this;e._socket&&e._socket.disconnect(),e.connectDefer&&e.connectDefer.reject("disconnect"),e.connectDefer=r.defer()},a.prototype.isConnected=function(){return this._socket?this._socket.connected:!1},a.prototype._send=function(n,r){var s=this,i=t.lowercase(n.method);s.connectDefer.promise.then(function(){e.debug&&o.info("$sails "+n.method+" "+n.url,n.data||""),s._socket.emit(i,{data:n.data,headers:n.headers,url:n.url},function(t){e.debug&&o.info("$sails"+n.method+" "+n.url+" response received",t),t=t||{};var s={data:t.body||t,status:t.statusCode||t.status||t.Status||200,headers:t.headers||{},config:n};delete s.headers,s.statusText=g[s.status],200<=s.status&&s.status<300?r.reject(s):r.resolve(s)})},function(){e.debug&&o.warn("$sails"+n.method+" "+n.url+" request terminated",n),r.reject({data:null,status:0,headers:{},config:n,statusText:null})})},a.prototype._req=function(e){var n=this,o=r.defer();if(e.url=e.url.replace(/^(.+)\/*\s*$/,"$1"),e.headers=e.headers||{},e.data=e.params||e.data||{},e.method=t.uppercase(e.method),"string"!=typeof e.url)throw new Error("Invalid or missing URL!");return n._send(e,o),o.promise},t.forEach(e.httpVerbs,function(e){a.prototype[e]=function(t){return t.method=t.method||e,a.prototype._req.apply(this,[t])}}),t.forEach(e.eventNames,function(e){a.prototype[e]=function(r,o){var s=this;null!==o&&t.isFunction(o)&&s._socket[e](r,function(e){n.$evalAsync(o.bind(s,e))})}},this),a}]}function p(e){if(!e.io)throw new Error("Socket.io-client not found. Ensure socket.io-client is loaded before this script");return e.io}t.module("ngSails",["ngSails.$sails"]);var g={100:"100 Continue",101:"101 Switching Protocols",102:"102 Processing",200:"200 OK",201:"201 Created",202:"202 Accepted",203:"203 Non-Authoritative Information",204:"204 No Content",205:"205 Reset Content",206:"206 Partial Content",207:"207 Multi-Status",208:"208 Already Reported",226:"226 IM Used",300:"300 Multiple Choices",301:"301 Moved Permanently",302:"302 Found",303:"303 See Other",304:"304 Not Modified",305:"305 Use Proxy",306:"306 (Unused)",307:"307 Temporary Redirect",308:"308 Permanent Redirect",400:"400 Bad Request",401:"401 Unauthorized",402:"402 Payment Required",403:"403 Forbidden",404:"404 Not Found",405:"405 Method Not Allowed",406:"406 Not Acceptable",407:"407 Proxy Authentication Required",408:"408 Request Timeout",409:"409 Conflict",410:"410 Gone",411:"411 Length Required",412:"412 Precondition Failed",413:"413 Payload Too Large",414:"414 URI Too Long",415:"415 Unsupported Media Type",416:"416 Range Not Satisfiable",417:"417 Expectation Failed",422:"422 Unprocessable Entity",423:"423 Locked",424:"424 Failed Dependency",426:"426 Upgrade Required",428:"428 Precondition Required",429:"429 Too Many Requests",431:"431 Request Header Fields Too Large",500:"500 Internal Server Error",501:"501 Not Implemented",502:"502 Bad Gateway",503:"503 Service Unavailable",504:"504 Gateway Timeout",505:"505 HTTP Version Not Supported",506:"506 Variant Also Negotiates",507:"507 Insufficient Storage",508:"508 Loop Detected",510:"510 Not Extended",511:"511 Network Authentication Required"};t.module("ngSails.$sails",["ngSails.$sailsIo","ngSails.$sailsInterceptor"]).provider("$sails",f),f.$inject=["$sailsInterceptorProvider","$sailsIoProvider"],t.module("ngSails.$sailsInterceptor",[]).provider("$sailsInterceptor",l),t.module("ngSails.$sailsIo",["ngSails.sailsSdk","ngSails.socketIo"]).provider("$sailsIo",h),t.module("ngSails.sailsSdk",[]).constant("sailsSdk",{info:{version:{key:"__sails_io_sdk_version",value:"0.11.0"},platform:{key:"__sails_io_sdk_platform",value:"undefined"==typeof module?"browser":"node"},language:{key:"__sails_io_sdk_language",value:"javascript"}},versionString:function(){var e=this;return function(){var n=[];return t.forEach(e.info,function(e){n.push(e.key+"="+e.value)}),n.join("&")}()}}),t.module("ngSails.socketIo",[]).factory("socketIo",p),p.$inject=["$window"]}(window,window.angular);
